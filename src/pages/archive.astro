---
import BaseLayout from '../layouts/BaseLayout.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { getCollection } from 'astro:content';
import FormattedDate from '../components/FormattedDate.astro';
import PageTitle from '../components/PageTitle.astro';
import Metadata from '../components/Metadata.astro';

const posts = (await getCollection('posts')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Group posts by year
const postsByYear = posts.reduce(
  (acc, post) => {
    const year = post.data.pubDate.getFullYear();
    if (!acc[year]) {
      acc[year] = [];
    }
    acc[year].push(post);
    return acc;
  },
  {} as Record<number, typeof posts>
);
---

<BaseLayout title={`Archive - ${SITE_TITLE}`} description={SITE_DESCRIPTION}>
  <style>
    .year-group {
      margin-bottom: var(--space-xl);
    }

    .year-group h2 {
      color: var(--theme-secondary);
      margin-bottom: var(--space-m);
    }

    .post-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .post-item {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: var(--space-s);
    }

    .post-item a {
      color: var(--theme-text);
      text-decoration: none;
      font-weight: bold;
    }

    .post-item a:hover {
      color: var(--theme-accent);
    }

    .post-date {
      color: var(--theme-secondary);
      font-size: 0.9em;
    }
  </style>

  <PageTitle title="Archive" />
  {
    Object.entries(postsByYear).map(([year, yearPosts]) => (
      <div class="year-group">
        <h2>{year}</h2>
        <ul class="post-list">
          {yearPosts.map(post => (
            <li class="post-item">
              <a href={`/${post.id}`} class="title-link mono no-underline">{post.data.title}</a>
              <small class="mono secondary">
                <FormattedDate date={post.data.pubDate} />
              </small>
            </li>
          ))}
        </ul>
      </div>
    ))
  }
</BaseLayout>
